1. Проверяем блокировку:

SELECT code, validity_period, attempts, blocked_until
FROM change_password_codes
WHERE user_id = $1;

2. Если blocked_until IS NOT NULL AND blocked_until > now() → отклоняем попытку, сообщаем пользователю «подождите N минут» Проверяем код и валидность:

code = user_input_code AND validity_period >= now()

3. Если код неверный:

UPDATE change_password_codes
SET attempts = attempts + 1,
blocked_until = CASE WHEN attempts + 1 >= 5 THEN now() + interval '15 minutes' ELSE blocked_until END
WHERE user_id = $1;
